<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>K3s on Phone - System Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SAP UI5 -->
    <script id="sap-ui-bootstrap"
        src="https://ui5.sap.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.ui.core,sap.ui.layout"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-frameOptions="trusted"
        data-sap-ui-language="en"
        data-sap-ui-resourceroots='{"k3s.dashboard": "./"}'>
    </script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Maplibre GL -->
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

    <!-- Maplibre GL Leaflet  -->
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet/leaflet-maplibre-gl.js"></script>
    
    <style>
        .system-tile {
            margin: 1rem;
            border-radius: 8px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0070f3;
        }
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .status-good { color: #107e3e; }
        .status-warning { color: #df6e0c; }
        .status-error { color: #bb0000; }
        
        body { 
            margin: 0; 
            font-family: '72', 'SAP-icons', Arial, sans-serif; 
            background-color: #f7f7f7;
        }
        
        .main-table {
            width: 100%;
            margin: 0;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #0070f3;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #bb0000;
        }
        
        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #0070f3;
        }
        
        .phone-status {
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="sapUiBody">
    <div id="content"></div>
    
    <!-- XML View Definition -->
    <script id="viewXml" type="text/xml">
        <mvc:View xmlns="sap.m"
            xmlns:mvc="sap.ui.core.mvc"
            xmlns:core="sap.ui.core"
            xmlns:html="http://www.w3.org/1999/xhtml"
            controllerName="k3s.dashboard.controller.Main"
            height="100%">
            
            <Shell>
                <App>
                    <Page title="System Health Dashboard">
                        <!-- Prototype Warning -->
                        <Panel headerText="âš ï¸ EXPERIMENTAL PROTOTYPE WARNING" class="system-tile">
                            <MessageStrip text="This is experimental prototype software. Features may not work as expected, may fail unpredictably, or may not function at all. Use entirely at your own risk. Only intended for exploration." type="Warning" class="sapUiMediumMarginBottom" />
                        </Panel>
                        
                        <Panel headerText="Loading System Information..." class="system-tile" id="loadingPanel">
                            <VBox alignItems="Center" class="loading">
                                <BusyIndicator size="2rem" />
                                <Text text="Fetching system health data..." />
                            </VBox>
                        </Panel>
                        
                        <Panel headerText="System Overview" class="system-tile" id="mainTablePanel" visible="false">
                            <Table id="systemTable" mode="None">
                                <columns>
                                    <Column><Label text="Property" /></Column>
                                    <Column><Label text="Value" /></Column>
                                </columns>
                            </Table>
                        </Panel>
                        
                        <Panel headerText="Memory Usage" class="system-tile" id="memoryPanel" visible="false">
                            <VBox>
                                <ProgressIndicator id="memoryProgress" width="100%" />
                                <HBox justifyContent="SpaceBetween" class="sapUiMediumMarginTop">
                                    <VBox>
                                        <Label text="Used Memory" class="metric-label" />
                                        <Text id="usedMemoryText" class="metric-value" />
                                    </VBox>
                                    <VBox>
                                        <Label text="Total Memory" class="metric-label" />
                                        <Text id="totalMemoryText" class="metric-value" />
                                    </VBox>
                                    <VBox>
                                        <Label text="Max Memory" class="metric-label" />
                                        <Text id="maxMemoryText" class="metric-value" />
                                    </VBox>
                                </HBox>
                            </VBox>
                        </Panel>
                        
                        <Panel headerText="Dashboard Controls" class="system-tile">
                            <VBox>
                                <HBox justifyContent="Center" class="sapUiMediumMargin">
                                    <Button id="refreshButton" text="Refresh Data" type="Emphasized" icon="sap-icon://refresh" press="onRefreshPress" />
                                    <Button id="autoRefreshButton" text="Auto-refresh: ON" type="Default" icon="sap-icon://media-pause" class="sapUiMediumMarginBegin" press="onAutoRefreshPress" />
                                </HBox>
                                <Text id="statusText" text="Last updated: Never" textAlign="Center" class="metric-label" />
                            </VBox>
                        </Panel>
                        
                        <!-- Android Phone Location Panel -->
                        <Panel id="phonePanel" headerText="ðŸ“± Android K3s Phone Server (Port 8005)" class="system-tile" visible="false">
                            <VBox>
                                <MessageStrip id="phoneStatus" text="Checking Android phone server..." type="Information" class="sapUiMediumMarginBottom" />
                                <MessageStrip text="Note: If using Android Linux Terminal, ensure port 8005 is forwarded using the Linux Terminal app UI" type="Information" class="sapUiMediumMarginBottom" visible="false" id="portForwardingNote" />
                                
                                <VBox id="phoneDataSection" visible="false">
                                    <HBox justifyContent="SpaceBetween" class="sapUiMediumMargin">
                                        <VBox width="45%">
                                            <Label text="ðŸ“ GPS Location" class="metric-label" />
                                            <Text id="locationText" class="metric-value" text="No data" />
                                            <Text id="accuracyText" class="metric-label" text="" />
                                        </VBox>
                                        <VBox width="45%">
                                            <Label text="ðŸ§­ Device Orientation" class="metric-label" />
                                            <Text id="orientationText" class="metric-value" text="No data" />
                                            <Text id="compassText" class="metric-label" text="" />
                                        </VBox>
                                    </HBox>
                                    
                                    <!-- Live Map -->
                                    <VBox id="mapSection" class="sapUiMediumMargin">
                                        <Label text="ðŸ—ºï¸ Live Location Map" class="metric-label" />
                                        <html:div id="map" class="map-container"></html:div>
                                    </VBox>
                                    
                                    <!-- Camera Feed -->
                                    <VBox id="cameraSection" class="sapUiMediumMargin" visible="false">
                                        <Label text="ðŸ“· Live Camera Feed" class="metric-label" />
                                        <VBox class="sapUiSmallMargin" style="border-radius: 8px; border: 2px solid #0070f3; overflow: hidden; max-width: 600px; background: #f8f9fa;">
                                            <html:img id="cameraImage" style="width: 100%; height: auto; display: block; max-height: 400px; object-fit: contain;" alt="Camera feed not available" />
                                            <Text id="cameraStatus" text="Loading camera..." textAlign="Center" class="metric-label" style="padding: 8px;" />
                                        </VBox>
                                    </VBox>
                                    
                                    <!-- Object Detection API Tester -->
                                    <VBox id="objectDetectionSection" class="sapUiMediumMargin" visible="false">
                                        <Label text="ðŸŽ¯ Object Detection API Tester (Rear Camera)" class="metric-label" />
                                        <Panel class="sapUiSmallMargin" style="border-radius: 8px; border: 2px solid #ff6b35; background: #fffaf8; padding: 12px;">
                                            <!-- API Testing Controls -->
                                            <VBox class="sapUiSmallMargin">
                                                <Label text="Test Parameters:" class="metric-label" />
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <Label text="Detection Threshold:" width="150px" />
                                                    <Slider id="thresholdSlider" value="0.5" min="0.1" max="1.0" step="0.1" width="200px" showAdvancedTooltip="true" />
                                                    <Text id="thresholdValue" text="0.5" style="margin-left: 8px;" />
                                                </HBox>
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <Label text="Max Results:" width="150px" />
                                                    <Slider id="maxResultsSlider" value="5" min="1" max="20" step="1" width="200px" showAdvancedTooltip="true" />
                                                    <Text id="maxResultsValue" text="5" style="margin-left: 8px;" />
                                                </HBox>
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <CheckBox id="includeImageCheck" text="Include Image in Response" selected="true" />
                                                </HBox>
                                                <HBox class="sapUiSmallMargin">
                                                    <Button id="testObjectDetectionBtn" text="ðŸŽ¯ Test Object Detection" type="Emphasized" press="onTestObjectDetection" />
                                                    <Button id="testCaptureBtn" text="ðŸ“¸ Test Capture API" type="Default" press="onTestCaptureAPI" style="margin-left: 8px;" />
                                                </HBox>
                                            </VBox>
                                            
                                            <!-- API Response Display -->
                                            <VBox id="apiResponseSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="API Response:" class="metric-label" style="margin-top: 12px;" />
                                                <Panel style="border-radius: 4px; border: 1px solid #ddd; background: #f9f9f9; max-height: 300px; overflow-y: auto;">
                                                    <Text id="apiResponseText" text="" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; padding: 8px;" />
                                                </Panel>
                                            </VBox>
                                            
                                            <!-- Object Detection Results -->
                                            <VBox id="detectionResultsSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="Detected Objects:" class="metric-label" style="margin-top: 12px;" />
                                                <List id="detectionResultsList" mode="None" />
                                            </VBox>
                                            
                                            <!-- Test Image Display -->
                                            <VBox id="testImageSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="Captured Image:" class="metric-label" style="margin-top: 12px;" />
                                                <VBox style="border-radius: 8px; border: 2px solid #ff6b35; overflow: hidden; max-width: 500px; background: #f8f9fa;">
                                                    <html:img id="testImage" style="width: 100%; height: auto; display: block; max-height: 300px; object-fit: contain;" alt="Test image will appear here" />
                                                </VBox>
                                            </VBox>
                                            
                                            <Text id="apiTestTimestamp" text="" textAlign="End" class="metric-label" style="margin-top: 8px; font-style: italic;" />
                                        </Panel>
                                    </VBox>

                                    <!-- AI Text API Tester -->
                                    <VBox id="aiTextSection" class="sapUiMediumMargin" visible="false">
                                        <Label text="ðŸ¤– AI Text API Tester" class="metric-label" />
                                        <Panel class="sapUiSmallMargin" style="border-radius: 8px; border: 2px solid #6f42c1; background: #faf8ff; padding: 12px;">
                                            <!-- AI Testing Controls -->
                                            <VBox class="sapUiSmallMargin">
                                                <Label text="Test Parameters:" class="metric-label" />
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <Label text="Prompt Text:" width="150px" />
                                                    <Input id="aiPromptInput" value="Describe what you see in detail" width="300px" />
                                                </HBox>
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <Label text="Camera Side:" width="150px" />
                                                    <Select id="aiCameraSelect" selectedKey="rear" width="200px">
                                                        <core:Item key="rear" text="Rear Camera" />
                                                        <core:Item key="front" text="Front Camera" />
                                                    </Select>
                                                </HBox>
                                                <HBox class="sapUiTinyMargin" alignItems="Center">
                                                    <CheckBox id="aiIncludeImageCheck" text="Include Image in Response" selected="true" />
                                                </HBox>
                                                <HBox class="sapUiSmallMargin">
                                                    <Button id="testAITextRearBtn" text="ðŸ¤– Test AI Text (Rear)" type="Emphasized" press="onTestAIText" data-camera="rear" />
                                                    <Button id="testAITextFrontBtn" text="ðŸ¤– Test AI Text (Front)" type="Default" press="onTestAIText" data-camera="front" style="margin-left: 8px;" />
                                                </HBox>
                                            </VBox>
                                            
                                            <!-- AI Response Display -->
                                            <VBox id="aiApiResponseSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="AI Response:" class="metric-label" style="margin-top: 12px;" />
                                                <Panel style="border-radius: 4px; border: 1px solid #ddd; background: #f9f9f9; max-height: 300px; overflow-y: auto;">
                                                    <Text id="aiApiResponseText" text="" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; padding: 8px;" />
                                                </Panel>
                                            </VBox>
                                            
                                            <!-- AI Text Result -->
                                            <VBox id="aiTextResultSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="AI Generated Text:" class="metric-label" style="margin-top: 12px;" />
                                                <Panel style="border-radius: 4px; border: 1px solid #6f42c1; background: #faf8ff; padding: 12px;">
                                                    <Text id="aiTextResult" text="" style="white-space: pre-wrap; font-size: 14px;" />
                                                </Panel>
                                            </VBox>
                                            
                                            <!-- AI Test Image Display -->
                                            <VBox id="aiTestImageSection" class="sapUiSmallMargin" visible="false">
                                                <Label text="Captured Image:" class="metric-label" style="margin-top: 12px;" />
                                                <VBox style="border-radius: 8px; border: 2px solid #6f42c1; overflow: hidden; max-width: 500px; background: #f8f9fa;">
                                                    <html:img id="aiTestImage" style="width: 100%; height: auto; display: block; max-height: 300px; object-fit: contain;" alt="Test image will appear here" />
                                                </VBox>
                                            </VBox>
                                            
                                            <Text id="aiTestTimestamp" text="" textAlign="End" class="metric-label" style="margin-top: 8px; font-style: italic;" />
                                        </Panel>
                                    </VBox>

                                    <!-- AI Description -->
                                    <VBox id="aiSection" class="sapUiMediumMargin" visible="false">
                                        <Label text="ðŸ¤– AI Description of Surroundings" class="metric-label" />
                                        <Panel class="sapUiSmallMargin" style="border-radius: 8px; border: 2px solid #28a745; background: #f8fff8; padding: 12px;">
                                            <Text id="aiDescriptionText" text="AI description will appear here..." style="white-space: pre-wrap;" />
                                            <Text id="aiTimestampText" text="" textAlign="End" class="metric-label" style="margin-top: 8px; font-style: italic;" />
                                        </Panel>
                                    </VBox>
                                </VBox>
                            </VBox>
                        </Panel>
                    </Page>
                </App>
            </Shell>
        </mvc:View>
    </script>
    
    <script>
        sap.ui.define("k3s.dashboard.controller.Main", [
            "sap/ui/core/mvc/Controller",
            "sap/m/MessageToast",
            "sap/ui/model/json/JSONModel"
        ], function(Controller, MessageToast, JSONModel) {
            "use strict";
            
            return Controller.extend("k3s.dashboard.controller.Main", {
                systemData: null,
                autoRefreshEnabled: true,
                autoRefreshInterval: null,
                aiRefreshInterval: null,
                lastUpdateTime: null,
                lastAiUpdate: 0,
                lastPhoneDataCapabilities: null,
                
                onInit: function() {
                    // Create device model for responsive features
                    const oDeviceModel = new JSONModel(sap.ui.Device);
                    oDeviceModel.setDefaultBindingMode("OneWay");
                    this.getView().setModel(oDeviceModel, "device");
                    
                    // Initialize cluster markers array
                    this.clusterMarkers = [];
                    
                    // Load initial data
                    this.loadSystemData();
                    
                    // Start auto-refresh
                    this.startAutoRefresh();
                    
                    // Start AI auto-refresh (every minute)
                    this.startAiAutoRefresh();
                },
                
                loadSystemData: function() {
                    this.updateStatus("Loading...");
                    
                    fetch('/health')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            this.systemData = data;
                            // Store the update time consistently
                            this.lastUpdateTime = new Date().toLocaleTimeString();
                            this.updateUI();
                            this.updateStatus("Last updated: " + this.lastUpdateTime);
                        })
                        .catch(error => {
                            console.error('Error loading system data:', error);
                            MessageToast.show("Error: " + error.message);
                        });
                    
                    // Load phone data
                    this.loadPhoneData();
                    
                    // Load cluster location data
                    this.loadClusterLocationData();
                },
                
                updateUI: function() {
                    if (!this.systemData) return;
                    
                    try {
                        // Hide loading panel
                        this.byId("loadingPanel").setVisible(false);
                        
                        // Show data panels
                        this.byId("mainTablePanel").setVisible(true);
                        this.byId("memoryPanel").setVisible(true);
                        
                        // Update main table
                        this.updateMainTable();
                        
                        // Update memory panel
                        this.updateMemoryPanel();
                    } catch (error) {
                        console.error("Error updating UI:", error);
                        MessageToast.show("UI update error: " + error.message);
                    }
                },
                
                loadPhoneData: function(refreshAI = false) {
                    const phonePanel = this.byId("phonePanel");
                    const phoneStatus = this.byId("phoneStatus");
                    const phoneDataSection = this.byId("phoneDataSection");
                    const portForwardingNote = this.byId("portForwardingNote");
                    
                    // Always show the panel to indicate we're checking for phone server
                    phonePanel.setVisible(true);
                    phoneStatus.setText("Checking Android phone server on port 8005...");
                    phoneStatus.setType("Information");
                    portForwardingNote.setVisible(false);
                    
                    const apiUrl = refreshAI ? '/api/phone?refreshAI=true' : '/api/phone';
                    
                    // Also load cluster location data
                    this.loadClusterLocationData();
                    
                    fetch(apiUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data.available && data.location) {
                                phoneStatus.setText("âœ… Connected to Android K3s Phone Server");
                                phoneStatus.setType("Success");
                                phoneDataSection.setVisible(true);
                                portForwardingNote.setVisible(false);
                                this.updatePhoneUI(data);
                            } else {
                                phoneStatus.setText("ðŸ“± Android phone server not available (requires port 8005)");
                                phoneStatus.setType("Warning");
                                phoneDataSection.setVisible(false);
                                portForwardingNote.setVisible(true);
                            }
                        })
                        .catch(error => {
                            console.log('Phone server not available:', error);
                            phoneStatus.setText("ðŸ“± Android phone server not available (requires port 8005)");
                            phoneStatus.setType("Warning");
                            phoneDataSection.setVisible(false);
                            portForwardingNote.setVisible(true);
                        });
                },
                
                loadClusterLocationData: function() {
                    // Load cluster location data for other nodes
                    fetch('/api/cluster/locations?phone-only=true')
                        .then(response => response.json())
                        .then(data => {
                            this.clusterLocationData = data;
                            console.log('Cluster location data loaded:', data);
                            // If map is already initialized, update it with cluster data
                            if (this.map && this.currentPhoneLocation) {
                                this.updateMapWithClusterNodes();
                            }
                        })
                        .catch(error => {
                            console.log('Cluster location data not available:', error);
                            this.clusterLocationData = null;
                        });
                },
                
                updatePhoneUI: function(phoneData) {
                    const locationText = this.byId("locationText");
                    const accuracyText = this.byId("accuracyText");
                    const orientationText = this.byId("orientationText");
                    const compassText = this.byId("compassText");
                    const cameraSection = this.byId("cameraSection");
                    const cameraImage = document.getElementById('cameraImage');
                    const cameraStatus = this.byId("cameraStatus");
                    const objectDetectionSection = this.byId("objectDetectionSection");
                    const aiSection = this.byId("aiSection");
                    const aiDescriptionText = this.byId("aiDescriptionText");
                    const aiTimestampText = this.byId("aiTimestampText");
                    
                    // Check capabilities to determine what features to show
                    const capabilities = phoneData.capabilities || {};
                    console.log("Server capabilities:", capabilities);
                    
                    // Store capabilities for AI refresh decisions
                    this.lastPhoneDataCapabilities = capabilities;
                    
                    // Update location data
                    if (phoneData.location) {
                        const loc = phoneData.location;
                        locationText.setText(`${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}`);
                        accuracyText.setText(`Accuracy: Â±${loc.accuracy.toFixed(1)}m | Alt: ${loc.altitude.toFixed(1)}m`);
                        
                        // Store current phone location for cluster node updates
                        this.currentPhoneLocation = { 
                            latitude: loc.latitude, 
                            longitude: loc.longitude 
                        };
                        
                        // Initialize and update map with orientation
                        const orientation = phoneData.orientation ? phoneData.orientation.azimuth : null;
                        this.initializeMap(loc.latitude, loc.longitude, orientation);
                    } else {
                        locationText.setText("No GPS data");
                        accuracyText.setText("");
                        this.currentPhoneLocation = null;
                    }
                    
                    // Update orientation data
                    if (phoneData.orientation) {
                        const orient = phoneData.orientation;
                        const compassDirection = this.getCompassDirection(orient.azimuth);
                        orientationText.setText(`${orient.azimuth.toFixed(1)}Â° ${compassDirection}`);
                        compassText.setText(`Pitch: ${orient.pitch.toFixed(1)}Â° | Roll: ${orient.roll.toFixed(1)}Â° | Accuracy: ${orient.accuracy}`);
                    } else {
                        orientationText.setText("No orientation data");
                        compassText.setText("");
                    }
                    
                    // Update camera feed - only show if camera capability is available
                    if (capabilities.camera && phoneData.camera && phoneData.camera.image) {
                        cameraSection.setVisible(true);
                        if (cameraImage) {
                            cameraImage.src = phoneData.camera.image;
                            const timestamp = new Date(phoneData.camera.timestamp).toLocaleTimeString();
                            cameraStatus.setText(`Last updated: ${timestamp}`);
                        }
                    } else {
                        cameraSection.setVisible(false);
                        if (!capabilities.camera) {
                            console.log("Camera features not available on this server");
                        }
                    }
                    
                    // Update AI description - only show if AI capability is available
                    if (capabilities.ai && phoneData.aiDescription && phoneData.aiDescription.description) {
                        aiSection.setVisible(true);
                        aiDescriptionText.setText(phoneData.aiDescription.description);
                        const timestamp = new Date(phoneData.aiDescription.timestamp).toLocaleTimeString();
                        aiTimestampText.setText(`Generated: ${timestamp}`);
                    } else {
                        aiSection.setVisible(false);
                        if (!capabilities.ai) {
                            console.log("AI features not available on this server");
                        }
                    }
                    
                    // Show object detection API tester if AI capabilities are available
                    if (capabilities.ai) {
                        objectDetectionSection.setVisible(true);
                        this.setupObjectDetectionControls();
                    } else {
                        objectDetectionSection.setVisible(false);
                    }
                    
                    // Show AI text API tester if AI capabilities are available
                    const aiTextSection = this.byId("aiTextSection");
                    if (capabilities.ai) {
                        aiTextSection.setVisible(true);
                    } else {
                        aiTextSection.setVisible(false);
                    }
                },
                
                initializeMap: function(lat, lng, orientation) {
                    const mapElement = document.getElementById('map');
                    if (!mapElement) {
                        console.error('Map element not found');
                        return;
                    }
                    
                    // Initialize map only once
                    if (!this.map) {
                        try {
                            this.map = L.map('map').setView([lat, lng], 15);
                            
                            // Add OpenStreetMap tiles
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: 'Â© OpenStreetMap contributors'
                            }).addTo(this.map);
                            
                            console.log('Map initialized successfully');
                        } catch (error) {
                            console.error('Error initializing map:', error);
                            return;
                        }
                    }
                    
                    // Update map location
                    this.map.setView([lat, lng], 15);
                    
                    // Remove existing phone marker
                    if (this.phoneMarker) {
                        this.map.removeLayer(this.phoneMarker);
                    }
                    
                    // Update cluster node markers
                    this.updateMapWithClusterNodes();
                    
                    // Create directional marker based on orientation
                    if (orientation !== null && orientation !== undefined) {
                        // Create custom icon with directional arrow
                        const phoneIcon = L.divIcon({
                            className: 'custom-phone-marker',
                            html: `
                                <div style="position: relative; width: 30px; height: 30px;">
                                    <!-- Phone base circle -->
                                    <div style="
                                        width: 20px; 
                                        height: 20px; 
                                        background: #0070f3; 
                                        border-radius: 50%; 
                                        border: 3px solid white; 
                                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                        position: absolute;
                                        top: 5px;
                                        left: 5px;
                                    "></div>
                                    <!-- Direction arrow -->
                                    <div style="
                                        width: 0; 
                                        height: 0; 
                                        border-left: 6px solid transparent; 
                                        border-right: 6px solid transparent; 
                                        border-bottom: 20px solid #ff4444; 
                                        position: absolute; 
                                        top: -5px; 
                                        left: 9px; 
                                        transform-origin: center bottom; 
                                        transform: rotate(${orientation}deg);
                                        transition: transform 0.3s ease;
                                    "></div>
                                </div>
                            `,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        // Add marker with orientation
                        this.phoneMarker = L.marker([lat, lng], { icon: phoneIcon })
                            .addTo(this.map)
                            .bindPopup(`
                                <strong>ðŸ“± Phone Location</strong><br/>
                                <strong>Coordinates:</strong><br/>
                                Lat: ${lat.toFixed(6)}<br/>
                                Lng: ${lng.toFixed(6)}<br/>
                                <strong>Orientation:</strong><br/>
                                ${orientation.toFixed(1)}Â° ${this.getCompassDirection(orientation)}
                            `);
                    } else {
                        // Standard marker without orientation
                        this.phoneMarker = L.marker([lat, lng])
                            .addTo(this.map)
                            .bindPopup(`
                                <strong>ðŸ“± Phone Location</strong><br/>
                                <strong>Coordinates:</strong><br/>
                                Lat: ${lat.toFixed(6)}<br/>
                                Lng: ${lng.toFixed(6)}<br/>
                                <em>No orientation data</em>
                            `);
                    }
                },
                
                updateMapWithClusterNodes: function() {
                    if (!this.map || !this.clusterLocationData) {
                        return;
                    }
                    
                    // Remove existing cluster markers
                    if (this.clusterMarkers) {
                        this.clusterMarkers.forEach(marker => {
                            this.map.removeLayer(marker);
                        });
                    }
                    this.clusterMarkers = [];
                    
                    const currentHostname = this.systemData ? this.systemData.hostname : null;
                    
                    // Add markers for each cluster node
                    if (this.clusterLocationData.nodes) {
                        this.clusterLocationData.nodes.forEach(node => {
                            // Skip the current node (it will have its own marker)
                            if (node.name === currentHostname) {
                                return;
                            }
                            
                            // Check if this node has valid coordinates
                            if (node.latitude && node.longitude && 
                                node.latitude !== 0 && node.longitude !== 0) {
                                
                                // Create muted marker for other nodes
                                const clusterIcon = L.divIcon({
                                    className: 'custom-cluster-marker',
                                    html: `
                                        <div style="position: relative; width: 24px; height: 24px;">
                                            <!-- Muted circle for other nodes -->
                                            <div style="
                                                width: 16px; 
                                                height: 16px; 
                                                background: #888888; 
                                                border-radius: 50%; 
                                                border: 2px solid white; 
                                                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                                                position: absolute;
                                                top: 4px;
                                                left: 4px;
                                                opacity: 0.7;
                                            "></div>
                                            <!-- Small phone icon -->
                                            <div style="
                                                position: absolute;
                                                top: 1px;
                                                left: 7px;
                                                font-size: 10px;
                                                color: white;
                                                text-shadow: 0 0 2px rgba(0,0,0,0.8);
                                            ">ðŸ“±</div>
                                        </div>
                                    `,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                });
                                
                                const marker = L.marker([node.latitude, node.longitude], { icon: clusterIcon })
                                    .addTo(this.map)
                                    .bindPopup(`
                                        <strong>ðŸ“± ${node.name}</strong><br/>
                                        <strong>Location:</strong> ${node.cityName || 'Unknown'}<br/>
                                        <strong>Coordinates:</strong><br/>
                                        Lat: ${node.latitude.toFixed(6)}<br/>
                                        Lng: ${node.longitude.toFixed(6)}<br/>
                                        <strong>Device:</strong> ${node.deviceType || 'phone'}<br/>
                                        <strong>IP:</strong> ${node.ip || 'N/A'}<br/>
                                        <em>Last updated: ${node.lastUpdated ? new Date(node.lastUpdated).toLocaleString() : 'Unknown'}</em>
                                    `);
                                
                                this.clusterMarkers.push(marker);
                                
                                console.log(`Added cluster marker for ${node.name} at ${node.latitude}, ${node.longitude}`);
                            }
                        });
                    }
                },
                
                getCompassDirection: function(azimuth) {
                    const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
                    const index = Math.round(azimuth / 22.5) % 16;
                    return directions[index];
                },
                
                updateMainTable: function() {
                    const table = this.byId("systemTable");
                    
                    // Clear existing items
                    table.destroyItems();
                    
                    // Add system information rows
                    const tableData = [
                        ["Hostname", this.systemData.hostname || "N/A"],
                        ["Status", (this.systemData.status || "unknown").toUpperCase()],
                        ["Uptime", this.formatUptime(this.systemData.uptime_ms || 0)],
                        ["CPU Load Average", this.systemData.system?.cpu_load_avg || "N/A"],
                        ["Operating System", (this.systemData.system?.os_name || "Unknown") + " " + (this.systemData.system?.os_version || "")],
                        ["OS Description", this.systemData.system?.os_description || "N/A"],
                        ["Architecture", this.systemData.system?.os_arch || "N/A"],
                        ["JVM", this.systemData.system?.jvm_name || "N/A"],
                        ["JVM Version", this.systemData.system?.jvm_version || "N/A"],
                        ["JVM Vendor", this.systemData.system?.jvm_vendor || "N/A"],
                        ["Last Updated", this.lastUpdateTime || "Never"]
                    ];
                    
                    tableData.forEach(([property, value]) => {
                        const item = new sap.m.ColumnListItem({
                            cells: [
                                new sap.m.Label({text: property, design: sap.m.LabelDesign.Bold}),
                                new sap.m.Text({text: value})
                            ]
                        });
                        table.addItem(item);
                    });
                },
                
                updateMemoryPanel: function() {
                    const memory = this.systemData.memory || {};
                    const usagePercent = memory.usage_percent || 0;
                    
                    // Update progress indicator
                    const progressIndicator = this.byId("memoryProgress");
                    progressIndicator.setPercentValue(usagePercent);
                    progressIndicator.setDisplayValue(usagePercent.toFixed(1) + "%");
                    
                    // Set color based on usage
                    if (usagePercent > 80) {
                        progressIndicator.setState(sap.ui.core.ValueState.Error);
                    } else if (usagePercent > 60) {
                        progressIndicator.setState(sap.ui.core.ValueState.Warning);
                    } else {
                        progressIndicator.setState(sap.ui.core.ValueState.Success);
                    }
                    
                    // Update memory text values
                    this.byId("usedMemoryText").setText((memory.used_mb || 0).toFixed(1) + " MB");
                    this.byId("totalMemoryText").setText((memory.total_mb || 0).toFixed(1) + " MB");
                    this.byId("maxMemoryText").setText((memory.max_mb || 0).toFixed(1) + " MB");
                },
                
                formatUptime: function(uptimeMs) {
                    const uptimeSeconds = Math.floor(uptimeMs / 1000);
                    const hours = Math.floor(uptimeSeconds / 3600);
                    const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                    const seconds = uptimeSeconds % 60;
                    
                    return String(hours).padStart(2, '0') + ':' + 
                           String(minutes).padStart(2, '0') + ':' + 
                           String(seconds).padStart(2, '0');
                },
                
                updateStatus: function(message) {
                    this.byId("statusText").setText(message);
                },
                
                startAutoRefresh: function() {
                    if (this.autoRefreshInterval) {
                        clearInterval(this.autoRefreshInterval);
                    }
                    
                    if (this.autoRefreshEnabled) {
                        this.autoRefreshInterval = setInterval(() => {
                            this.loadSystemData();
                        }, 10000); // Refresh every 10 seconds
                    }
                },
                
                startAiAutoRefresh: function() {
                    if (this.aiRefreshInterval) {
                        clearInterval(this.aiRefreshInterval);
                    }
                    
                    this.aiRefreshInterval = setInterval(() => {
                        // Check if we should refresh AI features
                        if (this.shouldRefreshAI()) {
                            console.log("Auto-refreshing AI description and camera...");
                            this.loadPhoneData(true); // Force fresh AI via refreshAI=true
                        } else {
                            console.log("Skipping AI refresh - no AI capabilities available");
                        }
                    }, 60000); // Check every 60 seconds (1 minute)
                },
                
                shouldRefreshAI: function() {
                    // Only refresh AI if we have recent data indicating AI capabilities are available
                    return this.lastPhoneDataCapabilities && 
                           (this.lastPhoneDataCapabilities.ai || this.lastPhoneDataCapabilities.camera);
                },
                
                onRefreshPress: function() {
                    this.loadSystemData();
                },
                
                onAutoRefreshPress: function() {
                    this.autoRefreshEnabled = !this.autoRefreshEnabled;
                    const button = this.byId("autoRefreshButton");
                    
                    if (this.autoRefreshEnabled) {
                        button.setText("Auto-refresh: ON");
                        button.setIcon("sap-icon://media-pause");
                        this.startAutoRefresh();
                    } else {
                        button.setText("Auto-refresh: OFF");
                        button.setIcon("sap-icon://media-play");
                        if (this.autoRefreshInterval) {
                            clearInterval(this.autoRefreshInterval);
                        }
                    }
                },
                
                setupObjectDetectionControls: function() {
                    // Setup slider event handlers
                    const thresholdSlider = this.byId("thresholdSlider");
                    const thresholdValue = this.byId("thresholdValue");
                    const maxResultsSlider = this.byId("maxResultsSlider");
                    const maxResultsValue = this.byId("maxResultsValue");
                    
                    if (thresholdSlider) {
                        thresholdSlider.attachLiveChange((oEvent) => {
                            const value = oEvent.getParameter("value");
                            thresholdValue.setText(value.toFixed(1));
                        });
                    }
                    
                    if (maxResultsSlider) {
                        maxResultsSlider.attachLiveChange((oEvent) => {
                            const value = oEvent.getParameter("value");
                            maxResultsValue.setText(value.toString());
                        });
                    }
                },
                
                onTestObjectDetection: function() {
                    const thresholdSlider = this.byId("thresholdSlider");
                    const maxResultsSlider = this.byId("maxResultsSlider");
                    const includeImageCheck = this.byId("includeImageCheck");
                    const apiResponseSection = this.byId("apiResponseSection");
                    const apiResponseText = this.byId("apiResponseText");
                    const detectionResultsSection = this.byId("detectionResultsSection");
                    const detectionResultsList = this.byId("detectionResultsList");
                    const testImageSection = this.byId("testImageSection");
                    const testImage = document.getElementById('testImage');
                    const apiTestTimestamp = this.byId("apiTestTimestamp");
                    const testButton = this.byId("testObjectDetectionBtn");
                    
                    // Get parameters
                    const threshold = thresholdSlider.getValue();
                    const maxResults = Math.round(maxResultsSlider.getValue());
                    const includeImage = includeImageCheck.getSelected();
                    
                    // Update button state
                    testButton.setText("ðŸ”„ Testing...");
                    testButton.setEnabled(false);
                    
                    // Build API URL with parameters
                    const params = new URLSearchParams({
                        threshold: threshold,
                        maxResults: maxResults,
                        returnImage: includeImage
                    });
                    
                    const apiUrl = `http://localhost:8005/ai/object_detection?${params.toString()}`;
                    
                    console.log("Testing object detection API:", apiUrl);
                    
                    fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Object detection response:", data);
                        
                        // Show API response
                        apiResponseSection.setVisible(true);
                        apiResponseText.setText(JSON.stringify(data, null, 2));
                        
                        // Process detection results
                        if (data.detections && data.detections.length > 0) {
                            detectionResultsSection.setVisible(true);
                            detectionResultsList.removeAllItems();
                            
                            data.detections.forEach((detection, index) => {
                                const listItem = new sap.m.StandardListItem({
                                    title: `${detection.category} (${(detection.score * 100).toFixed(1)}%)`,
                                    description: `Bounding box: [${detection.boundingBox.originX}, ${detection.boundingBox.originY}, ${detection.boundingBox.width}, ${detection.boundingBox.height}]`,
                                    icon: "sap-icon://target-group"
                                });
                                detectionResultsList.addItem(listItem);
                            });
                        } else {
                            detectionResultsSection.setVisible(false);
                        }
                        
                        // Show image if included
                        if (data.image && includeImage) {
                            testImageSection.setVisible(true);
                            if (testImage) {
                                testImage.src = data.image;
                            }
                        } else {
                            testImageSection.setVisible(false);
                        }
                        
                        // Update timestamp
                        const timestamp = new Date().toLocaleTimeString();
                        apiTestTimestamp.setText(`Test completed: ${timestamp}`);
                        
                        sap.m.MessageToast.show(`Object detection completed! Found ${data.detections ? data.detections.length : 0} objects.`);
                    })
                    .catch(error => {
                        console.error("Object detection test error:", error);
                        
                        // Show error in response section
                        apiResponseSection.setVisible(true);
                        apiResponseText.setText(`Error: ${error.message}`);
                        
                        // Hide other sections
                        detectionResultsSection.setVisible(false);
                        testImageSection.setVisible(false);
                        
                        const timestamp = new Date().toLocaleTimeString();
                        apiTestTimestamp.setText(`Test failed: ${timestamp}`);
                        
                        sap.m.MessageToast.show("Object detection test failed: " + error.message);
                    })
                    .finally(() => {
                        // Reset button state
                        testButton.setText("ðŸŽ¯ Test Object Detection");
                        testButton.setEnabled(true);
                    });
                },
                
                onTestCaptureAPI: function() {
                    const apiResponseSection = this.byId("apiResponseSection");
                    const apiResponseText = this.byId("apiResponseText");
                    const detectionResultsSection = this.byId("detectionResultsSection");
                    const testImageSection = this.byId("testImageSection");
                    const testImage = document.getElementById('testImage');
                    const apiTestTimestamp = this.byId("apiTestTimestamp");
                    const testButton = this.byId("testCaptureBtn");
                    
                    // Update button state
                    testButton.setText("ðŸ”„ Testing...");
                    testButton.setEnabled(false);
                    
                    const apiUrl = '/api/phone/capture';
                    
                    console.log("Testing capture API:", apiUrl);
                    
                    fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Capture API response:", data);
                        
                        // Show API response
                        apiResponseSection.setVisible(true);
                        apiResponseText.setText(JSON.stringify(data, null, 2));
                        
                        // Hide detection results (capture API doesn't return detections)
                        detectionResultsSection.setVisible(false);
                        
                        // Show image if available
                        if (data.image) {
                            testImageSection.setVisible(true);
                            if (testImage) {
                                testImage.src = data.image;
                            }
                        } else {
                            testImageSection.setVisible(false);
                        }
                        
                        // Update timestamp
                        const timestamp = new Date().toLocaleTimeString();
                        apiTestTimestamp.setText(`Capture test completed: ${timestamp}`);
                        
                        const detections = data.objectDetection ? data.objectDetection.detections : null;
                        const objectCount = detections ? detections.length : 0;
                        sap.m.MessageToast.show(`Capture completed! Found ${objectCount} objects via embedded object detection.`);
                    })
                    .catch(error => {
                        console.error("Capture API test error:", error);
                        
                        // Show error in response section
                        apiResponseSection.setVisible(true);
                        apiResponseText.setText(`Error: ${error.message}`);
                        
                        // Hide other sections
                        detectionResultsSection.setVisible(false);
                        testImageSection.setVisible(false);
                        
                        const timestamp = new Date().toLocaleTimeString();
                        apiTestTimestamp.setText(`Capture test failed: ${timestamp}`);
                        
                        sap.m.MessageToast.show("Capture API test failed: " + error.message);
                    })
                    .finally(() => {
                        // Reset button state
                        testButton.setText("ðŸ“¸ Test Capture API");
                        testButton.setEnabled(true);
                    });
                },
                
                onTestAIText: function(oEvent) {
                    const source = oEvent.getSource();
                    const camera = source.data("camera") || this.byId("aiCameraSelect").getSelectedKey();
                    const aiPromptInput = this.byId("aiPromptInput");
                    const aiIncludeImageCheck = this.byId("aiIncludeImageCheck");
                    const aiApiResponseSection = this.byId("aiApiResponseSection");
                    const aiApiResponseText = this.byId("aiApiResponseText");
                    const aiTextResultSection = this.byId("aiTextResultSection");
                    const aiTextResult = this.byId("aiTextResult");
                    const aiTestImageSection = this.byId("aiTestImageSection");
                    const aiTestImage = document.getElementById('aiTestImage');
                    const aiTestTimestamp = this.byId("aiTestTimestamp");
                    
                    // Get parameters
                    const text = aiPromptInput.getValue() || "Describe what you see in detail";
                    const includeImage = aiIncludeImageCheck.getSelected();
                    
                    // Update button state
                    const originalText = source.getText();
                    source.setText("ðŸ”„ Processing...");
                    source.setEnabled(false);
                    
                    // Build request body
                    const requestBody = JSON.stringify({
                        text: text,
                        camera: camera,
                        returnImage: includeImage
                    });
                    
                    console.log("Testing AI text API with camera:", camera, "text:", text);
                    
                    fetch('/api/phone/ai-text', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: requestBody
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("AI text response:", data);
                        
                        // Show API response
                        aiApiResponseSection.setVisible(true);
                        aiApiResponseText.setText(JSON.stringify(data, null, 2));
                        
                        // Show AI generated text
                        if (data.response || data.text) {
                            aiTextResultSection.setVisible(true);
                            const aiResponse = data.response || data.text;
                            aiTextResult.setText(aiResponse);
                        } else {
                            aiTextResultSection.setVisible(false);
                        }
                        
                        // Show image if included
                        if (data.image && includeImage) {
                            aiTestImageSection.setVisible(true);
                            if (aiTestImage) {
                                if (data.image.startsWith('data:image')) {
                                    aiTestImage.src = data.image;
                                } else {
                                    aiTestImage.src = 'data:image/jpeg;base64,' + data.image;
                                }
                            }
                        } else {
                            aiTestImageSection.setVisible(false);
                        }
                        
                        // Update timestamp
                        const timestamp = new Date().toLocaleTimeString();
                        aiTestTimestamp.setText(`AI test completed: ${timestamp}`);
                        
                        sap.m.MessageToast.show(`AI text response generated for ${camera} camera!`);
                    })
                    .catch(error => {
                        console.error("AI text test error:", error);
                        
                        // Show error in response section
                        aiApiResponseSection.setVisible(true);
                        aiApiResponseText.setText(`Error: ${error.message}`);
                        
                        // Hide other sections
                        aiTextResultSection.setVisible(false);
                        aiTestImageSection.setVisible(false);
                        
                        const timestamp = new Date().toLocaleTimeString();
                        aiTestTimestamp.setText(`AI test failed: ${timestamp}`);
                        
                        sap.m.MessageToast.show("AI text test failed: " + error.message);
                    })
                    .finally(() => {
                        // Reset button state
                        source.setText(originalText);
                        source.setEnabled(true);
                    });
                }
            });
        });
        
        sap.ui.getCore().attachInit(function() {
            "use strict";
            
            // Create XML view
            sap.ui.require([
                "sap/ui/core/mvc/XMLView",
                "sap/ui/core/Core"
            ], function(XMLView, Core) {
                XMLView.create({
                    definition: document.getElementById("viewXml").textContent,
                    controllerName: "k3s.dashboard.controller.Main"
                }).then(function(oView) {
                    oView.placeAt("content");
                    Core.getMessageManager().registerObject(oView, true);
                }).catch(function(error) {
                    console.error("Error creating view:", error);
                    document.getElementById("content").innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #bb0000;">'+
                        '<h2>View Creation Error</h2>'+
                        '<p>Failed to create view: ' + error.message + '</p>'+
                        '<p>Please check the browser console for more details.</p>'+
                        '</div>';
                });
            });
        });
    </script>
</body>
</html>